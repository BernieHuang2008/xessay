<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»¿å†™è®­ç»ƒ - ä½œæ–‡è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            /* background: linear-gradient(135deg, #ffffff 0%, #764ba2 100%); */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: #ffffff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .back-btn:hover {
            background: #5a6fd8;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .session-info {
            font-size: 14px;
            color: #666;
        }

        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 80px);
            flex-direction: column;
        }

        .content-section {
            flex: 1;
            /* background: rgba(255, 255, 255, 0.95); */
            /* border-radius: 12px; */
            padding: 20px;
            /* box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .content-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffffff;
        }

        .original-text {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            line-height: 1.6;
            color: #444;
            min-height: 200px;
            max-height: calc(100% - 150px);
        }

        .segment-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .segment-btn {
            background: #fff;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
            color: black;
        }

        .segment-btn.active {
            background: #5a6fd8;
            color: white;
            border-color: #ffffff;
        }

        .segment-btn:hover {
            background: #5a6fd8;
        }

        .segment-btn.active:hover {
            background: #5a6fd8;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }

        .mode-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .mode-btn:hover {
            background: #e9ecef;
        }

        .mode-btn.active:hover {
            background: #218838;
        }

        .submit-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #5a6fd8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .submit-btn:hover {
            background: #5a6fd8;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .drawing-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .drawing-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffffff;
        }

        .drawing-area {
            flex: 1;
            position: relative;
            min-height: 400px;
        }

        .previous-work {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .no-previous-work {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #999;
            font-size: 16px;
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
            font-size: 16px;
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #fab1a0;
        }

        .success {
            background: #e6ffe6;
            color: #00b894;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #a8e6cf;
        }

        /* Markdownæ ·å¼ */
        .original-text h1,
        .original-text h2,
        .original-text h3 {
            margin: 15px 0 10px 0;
            color: #333;
        }

        .original-text h1 {
            font-size: 22px;
        }

        .original-text h2 {
            font-size: 20px;
        }

        .original-text h3 {
            font-size: 18px;
        }

        .original-text p {
            margin: 10px 0;
            text-align: justify;
        }

        .original-text ul,
        .original-text ol {
            margin: 10px 0 10px 20px;
        }

        .original-text li {
            margin: 5px 0;
        }

        .original-text blockquote {
            border-left: 4px solid #ffffff;
            padding-left: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #555;
            background: rgba(102, 126, 234, 0.05);
        }

        .original-text code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }

            .content-section,
            .drawing-section {
                flex: none;
                min-height: 300px;
            }
        }
    </style>
    <!-- å¼•å…¥marked.jsç”¨äºMarkdownè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="#" class="back-btn" onclick="goBack()">â† è¿”å›</a>
                <div class="logo">ä»¿å†™è®­ç»ƒ</div>
            </div>
            <div class="session-info" id="sessionInfo">
                Session ID: <span id="sessionId"></span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-section">
            <div class="content-header">ğŸ“– åŸæ–‡å†…å®¹</div>
            <div class="original-text" id="originalText">
                <div class="loading">æ­£åœ¨åŠ è½½ä»¿å†™ææ–™...</div>
            </div>

            <div class="segment-buttons" id="segmentButtons" style="display: none;">
                <!-- è¯­æ®µæŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="mode-buttons" id="modeButtons" style="display: none;">
                <button class="mode-btn active" onclick="setMode('new')">æ–°å»ºä»¿å†™</button>
                <button class="mode-btn" onclick="setMode('previous')">æŸ¥çœ‹å†å²</button>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitImitation()" disabled style="display: none;">
                æäº¤ä»¿å†™ä½œå“
            </button>
        </div>

        <div class="drawing-section">
            <div class="drawing-header" id="drawingHeader">âœï¸ ä»¿å†™åŒºåŸŸ</div>
            <div class="drawing-area" id="drawingArea">
                <div class="loading">æ­£åœ¨åˆå§‹åŒ–...</div>
            </div>
        </div>
    </div>

    <script src="base_url.js"></script>
    <script src="drawing-canvas.js"></script>
    <script>
        let currentSessionId = '';
        let drawingCanvas = null;
        let imitationData = {};
        let currentSegment = '1';
        let currentMode = 'new'; // 'new' or 'previous'
        let currentPreviousIndex = 0;
        let isSubmitting = false;

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = `index.html?sessionid=${currentSessionId}`;
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            currentSessionId = getUrlParameter('sessionid');

            if (!currentSessionId) {
                showError('ç¼ºå°‘session IDå‚æ•°');
                return;
            }

            document.getElementById('sessionId').textContent = currentSessionId;

            // åŠ è½½ä»¿å†™ææ–™
            await loadImitationData();
        }

        // åŠ è½½ä»¿å†™ææ–™
        async function loadImitationData() {
            try {
                const response = await fetch(`${BASE_URL}/getImitation?sessionid=${currentSessionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                imitationData = data.imitations || {};

                if (Object.keys(imitationData).length === 0) {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„ä»¿å†™ææ–™');
                }

                // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªè¯­æ®µ
                const segments = Object.keys(imitationData).sort((a, b) => parseInt(a) - parseInt(b));
                currentSegment = segments[0];

                // ç”Ÿæˆè¯­æ®µæŒ‰é’®
                generateSegmentButtons();

                // æ˜¾ç¤ºå½“å‰è¯­æ®µå†…å®¹
                displaySegmentContent();

                // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                document.getElementById('segmentButtons').style.display = 'flex';
                document.getElementById('modeButtons').style.display = 'flex';
                document.getElementById('submitBtn').style.display = 'block';

                // åˆå§‹åŒ–ç»˜å›¾åŒº
                setMode('new');

            } catch (error) {
                console.error('åŠ è½½ä»¿å†™ææ–™å¤±è´¥:', error);
                showError('åŠ è½½ä»¿å†™ææ–™å¤±è´¥: ' + error.message);

                // æ˜¾ç¤ºç¤ºä¾‹å†…å®¹
                showExampleContent();
            }
        }

        // ç”Ÿæˆè¯­æ®µæŒ‰é’®
        function generateSegmentButtons() {
            const container = document.getElementById('segmentButtons');
            container.innerHTML = '';

            const segments = Object.keys(imitationData).sort((a, b) => parseInt(a) - parseInt(b));

            segments.forEach(segmentId => {
                const button = document.createElement('button');
                button.className = 'segment-btn';
                button.textContent = `è¯­æ®µ${segmentId}`;
                button.onclick = () => selectSegment(segmentId);

                if (segmentId === currentSegment) {
                    button.classList.add('active');
                }

                container.appendChild(button);
            });
        }

        // é€‰æ‹©è¯­æ®µ
        function selectSegment(segmentId) {
            currentSegment = segmentId;
            currentPreviousIndex = 0;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.segment-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ˜¾ç¤ºå†…å®¹
            displaySegmentContent();

            // æ ¹æ®å½“å‰æ¨¡å¼æ›´æ–°æ˜¾ç¤º
            if (currentMode === 'new') {
                setMode('new');
            } else {
                setMode('previous');
            }
        }

        // æ˜¾ç¤ºè¯­æ®µå†…å®¹
        function displaySegmentContent() {
            const segment = imitationData[currentSegment];
            if (!segment) return;

            const htmlContent = marked.parse(segment.origin_md || 'æš‚æ— å†…å®¹');
            document.getElementById('originalText').innerHTML = htmlContent;
        }

        // è®¾ç½®æ¨¡å¼
        function setMode(mode) {
            currentMode = mode;
            currentPreviousIndex = 0;

            // æ›´æ–°æ¨¡å¼æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (mode === 'new') {
                document.querySelector('.mode-btn[onclick="setMode(\'new\')"]').classList.add('active');
                initializeNewImitation();
            } else {
                document.querySelector('.mode-btn[onclick="setMode(\'previous\')"]').classList.add('active');
                showPreviousWork();
            }
        }

        // åˆå§‹åŒ–æ–°ä»¿å†™
        function initializeNewImitation() {
            const drawingArea = document.getElementById('drawingArea');
            const drawingHeader = document.getElementById('drawingHeader');

            drawingHeader.textContent = 'âœï¸ ä»¿å†™åŒºåŸŸ - æ–°å»ºä»¿å†™';
            drawingArea.innerHTML = '';

            try {
                drawingCanvas = new DrawingCanvas('drawingArea', {
                    backgroundColor: '#ffffff',
                    penColor: '#000000',
                    penSize: 2,
                    eraserSize: 10,
                    maxUndoSteps: 20
                });

                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'æäº¤ä»¿å†™ä½œå“';

            } catch (error) {
                console.error('åˆå§‹åŒ–ç»˜å›¾åŒºå¤±è´¥:', error);
                showError('åˆå§‹åŒ–ç»˜å›¾åŒºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå†å²ä½œå“
        function showPreviousWork() {
            const segment = imitationData[currentSegment];
            const prevWorks = segment?.prev_works || [];

            const drawingArea = document.getElementById('drawingArea');
            const drawingHeader = document.getElementById('drawingHeader');

            drawingCanvas = null; // æ¸…é™¤ç»˜å›¾canvas
            document.getElementById('submitBtn').disabled = true;

            if (prevWorks.length === 0) {
                drawingHeader.textContent = 'ğŸ“ å†å²ä½œå“ - æš‚æ— å†å²ä½œå“';
                drawingArea.innerHTML = '<div class="no-previous-work">è¯¥è¯­æ®µæš‚æ— å†å²ä»¿å†™ä½œå“</div>';
                return;
            }

            // åˆ›å»ºå†å²ä½œå“æŸ¥çœ‹å™¨
            drawingHeader.innerHTML = `
                ğŸ“ å†å²ä½œå“ - ç¬¬${currentPreviousIndex + 1}ä»½ / å…±${prevWorks.length}ä»½
                <div style="margin-top: 10px;">
                    <button onclick="previousWork()" ${currentPreviousIndex <= 0 ? 'disabled' : ''} style="margin-right: 10px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ä¸Šä¸€ä»½</button>
                    <button onclick="nextWork()" ${currentPreviousIndex >= prevWorks.length - 1 ? 'disabled' : ''} style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">ä¸‹ä¸€ä»½</button>
                </div>
            `;

            // æ˜¾ç¤ºå½“å‰å†å²ä½œå“
            const currentWork = prevWorks[currentPreviousIndex];
            const htmlContent = marked.parse(currentWork || 'æš‚æ— å†…å®¹');
            drawingArea.innerHTML = `<div style="padding: 20px; background: #f9f9f9; border-radius: 8px; height: 100%; overflow-y: auto; line-height: 1.6;">${htmlContent}</div>`;
        }

        // ä¸Šä¸€ä»½ä½œå“
        function previousWork() {
            if (currentPreviousIndex > 0) {
                currentPreviousIndex--;
                showPreviousWork();
            }
        }

        // ä¸‹ä¸€ä»½ä½œå“
        function nextWork() {
            const segment = imitationData[currentSegment];
            const prevWorks = segment?.prev_works || [];

            if (currentPreviousIndex < prevWorks.length - 1) {
                currentPreviousIndex++;
                showPreviousWork();
            }
        }

        // æäº¤ä»¿å†™ä½œå“
        async function submitImitation() {
            if (isSubmitting || currentMode !== 'new') return;

            if (!drawingCanvas) {
                showError('è¯·å…ˆåˆ›å»ºä»¿å†™å†…å®¹');
                return;
            }

            if (!confirm('ç¡®å®šè¦æäº¤å½“å‰çš„ä»¿å†™ä½œå“å—ï¼Ÿ')) {
                return;
            }

            isSubmitting = true;
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æäº¤ä¸­...';
            submitBtn.disabled = true;

            try {
                drawingCanvas.toBlob(async (blob) => {
                    try {
                        const formData = new FormData();
                        formData.append('image', blob, 'imitation.png');

                        const response = await fetch(`${BASE_URL}/submitImitation?sessionid=${currentSessionId}&imitid=${currentSegment}`, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            showSuccess('ä»¿å†™ä½œå“æäº¤æˆåŠŸï¼');

                            // é‡æ–°åŠ è½½æ•°æ®ä»¥è·å–æœ€æ–°çš„å†å²ä½œå“
                            setTimeout(async () => {
                                await loadImitationData();
                            }, 1000);
                        } else {
                            throw new Error(result.message || 'æäº¤å¤±è´¥');
                        }

                    } catch (error) {
                        console.error('æäº¤å¤±è´¥:', error);
                        showError('æäº¤å¤±è´¥: ' + error.message);
                    } finally {
                        isSubmitting = false;
                        submitBtn.textContent = originalText;
                        if (currentMode === 'new') {
                            submitBtn.disabled = false;
                        }
                    }
                }, 'image/png', 0.8);

            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                showError('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + error.message);
                isSubmitting = false;
                submitBtn.textContent = originalText;
                if (currentMode === 'new') {
                    submitBtn.disabled = false;
                }
            }
        }

        // æ˜¾ç¤ºç¤ºä¾‹å†…å®¹
        function showExampleContent() {
            imitationData = {
                '1': {
                    origin_md: `# ç¤ºä¾‹åŸæ–‡ç‰‡æ®µ1

æ˜¥å¤©æ¥äº†ï¼Œä¸‡ç‰©å¤è‹ã€‚æŸ³æ ‘æŠ½å‡ºäº†æ–°èŠ½ï¼Œå«©ç»¿å«©ç»¿çš„ï¼Œåƒå°å§‘å¨˜çš„çœ‰æ¯›ã€‚æ¡ƒèŠ±å¼€äº†ï¼Œç²‰çº¢ç²‰çº¢çš„ï¼Œåƒå°æœ‹å‹çš„è„¸è›‹ã€‚

**ä»¿å†™è¦æ±‚ï¼š**
- æ¨¡ä»¿æå†™æ˜¥å¤©æ™¯ç‰©çš„æ–¹æ³•
- è¿ç”¨æ¯”å–»ä¿®è¾æ‰‹æ³•
- æ³¨æ„é¢œè‰²è¯çš„ä½¿ç”¨`,
                    prev_works: []
                },
                '2': {
                    origin_md: `# ç¤ºä¾‹åŸæ–‡ç‰‡æ®µ2

å¤å¤©çš„é›¨æ¥å¾—çªç„¶ï¼Œæ¥å¾—çŒ›çƒˆã€‚åˆšæ‰è¿˜æ˜¯æ™´ç©ºä¸‡é‡Œï¼Œè½¬çœ¼é—´ä¹Œäº‘å¯†å¸ƒï¼Œé›·å£°éš†éš†ã€‚è±†å¤§çš„é›¨ç‚¹ç ¸åœ¨åœ°é¢ä¸Šï¼Œæº…èµ·æœµæœµæ°´èŠ±ã€‚

**ä»¿å†™è¦æ±‚ï¼š**
- å­¦ä¹ æå†™å¤©æ°”å˜åŒ–çš„æŠ€å·§  
- æ³¨æ„åŠ¨è¯çš„å‡†ç¡®è¿ç”¨
- ä½“ä¼šæ‹Ÿäººå’Œæ¯”å–»çš„è¡¨è¾¾æ•ˆæœ`,
                    prev_works: []
                }
            };

            currentSegment = '1';
            generateSegmentButtons();
            displaySegmentContent();

            document.getElementById('segmentButtons').style.display = 'flex';
            document.getElementById('modeButtons').style.display = 'flex';
            document.getElementById('submitBtn').style.display = 'block';

            setMode('new');
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;

            const originalText = document.getElementById('originalText');
            originalText.insertBefore(errorDiv, originalText.firstChild);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;

            const originalText = document.getElementById('originalText');
            originalText.insertBefore(successDiv, originalText.firstChild);

            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 5000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);

        // é˜²æ­¢æ„å¤–ç¦»å¼€é¡µé¢
        window.addEventListener('beforeunload', (e) => {
            if (drawingCanvas && currentMode === 'new' && !isSubmitting) {
                e.preventDefault();
                e.returnValue = 'æ‚¨çš„ä»¿å†™å†…å®¹å¯èƒ½ä¼šä¸¢å¤±ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        });
    </script>
</body>

</html>